<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí POS B√°n H√†ng - H·ªá Th·ªëng Qu·∫£n L√Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .pos-container {
            max-height: 100vh;
            overflow: hidden;
        }
        .product-grid {
            max-height: 55vh;
            overflow-y: auto;
        }
        .cart-section {
            max-height: 45vh;
            overflow-y: auto; 
        }
        .product-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .product-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .cart-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .total-section {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }
        .search-box {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 15px 0;
            border-bottom: 2px solid #dee2e6;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: #6c757d;
            color: white;
            border-radius: 5px;
            font-size: 16px;
        }
        .quantity-btn:hover {
            background: #495057;
        }
        .out-of-stock {
            opacity: 0.5;
            pointer-events: none;
        }
        .error-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .customer-toggle-btn {
            position: fixed;
            bottom: 150px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .customer-toggle-btn:hover {
            background: linear-gradient(45deg, #0056b3, #004085);
            transform: scale(1.1);
        }
        .customer-info-compact {
            background: rgba(0, 123, 255, 0.1);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .vip-badge {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .pending-vip-badge {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .category-filters {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .category-btn {
            margin: 2px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .category-btn.active {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            transform: scale(1.05);
        }
        .category-btn:not(.active):hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="navbar-brand" href="/user/dashboard">
                <i class="fas fa-cash-register"></i> üõí POS B√°n H√†ng
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/user/pos/history">
                    <i class="fas fa-history"></i> L·ªãch S·ª≠ Giao D·ªãch
                </a>
                <a class="nav-link" href="/user/dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <span class="navbar-text">
                    <i class="fas fa-user"></i> <span th:text="${username}">User</span>
                </span>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </a>
            </div>
        </div>
    </nav>

    <!-- Error/Success Alerts -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show error-alert" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show error-alert" role="alert">
        <i class="fas fa-check-circle"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${vipMessage}" class="alert alert-info alert-dismissible fade show error-alert" role="alert">
        <i class="fas fa-crown"></i>
        <span th:text="${vipMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Customer Toggle Button -->
    <button class="customer-toggle-btn" onclick="toggleCustomerModal()" title="Qu·∫£n l√Ω kh√°ch h√†ng">
        <i class="fas fa-user"></i>
    </button>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- C·ªôt tr√°i: Danh s√°ch s·∫£n ph·∫©m -->
            <div class="col-md-8">
                <!-- T√¨m ki·∫øm s·∫£n ph·∫©m -->
                <div class="search-box">
                    <div class="input-group mb-3">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control form-control-lg" 
                               id="searchProduct" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m theo t√™n ho·∫∑c m√£..."
                               onkeyup="performProductSearch(this.value)">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                            <i class="fas fa-times"></i> X√≥a
                        </button>
                    </div>
                    
                    <!-- Category Filters -->
                    <div class="category-filters">
                        <h6 class="mb-3"><i class="fas fa-tags"></i> Danh M·ª•c S·∫£n Ph·∫©m</h6>
                        <div class="d-flex flex-wrap" id="categoryContainer">
                            <!-- Danh m·ª•c s·∫Ω ƒë∆∞·ª£c t·∫£i ƒë·ªông t·ª´ database -->
                        </div>
                    </div>
                    
                    <div id="searchResultCount" class="mt-2 text-muted" style="display: none;"></div>
                </div>

                <!-- Danh s√°ch s·∫£n ph·∫©m -->
                <div class="product-grid" id="productGrid">
                    <div class="row g-3">
                        <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
                    </div>
                    <!-- No products found -->
                    <div id="noProductsFound" class="text-center py-5" style="display: none;">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</h5>
                        <p class="text-muted">Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c ch·ªçn danh m·ª•c kh√°c</p>
                    </div>
                </div>
            </div>

            <!-- C·ªôt ph·∫£i: Gi·ªè h√†ng v√† thanh to√°n -->
            <div class="col-md-4">
                <!-- Th√¥ng tin kh√°ch h√†ng compact -->
                <div id="customerInfoCompact" class="customer-info-compact" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong id="customerNameDisplay">Kh√°ch l·∫ª</strong>
                            <span id="vipBadge" class="vip-badge ms-2" style="display: none;">VIP -5%</span>
                            <span id="pendingVipBadge" class="pending-vip-badge ms-2" style="display: none;">Ch·ªù duy·ªát VIP</span>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleCustomerModal()">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <small class="text-muted" id="customerPhoneDisplay"></small>
                </div>

                <!-- Gi·ªè h√†ng -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart"></i> 
                            Gi·ªè H√†ng (<span id="cartItemCount">0</span>)
                        </h5>
                    </div>
                    
                    <div class="card-body p-2 cart-section" id="cartItems">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                            <p class="mt-2">Gi·ªè h√†ng tr·ªëng</p>
                            <small>Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o gi·ªè</small>
                        </div>
                    </div>
                </div>

                <!-- T·ªïng ti·ªÅn v√† thanh to√°n -->
                <div class="total-section">
                    <div class="d-flex justify-content-between mb-2">
                        <span>T·ªïng s·∫£n ph·∫©m:</span>
                        <strong id="totalItems">0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>T·∫°m t√≠nh:</span>
                        <strong id="subtotal">0 VNƒê</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Gi·∫£m gi√° VIP:</span>
                        <strong id="vipDiscount">0 VNƒê</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3 fs-4">
                        <span><strong>TH√ÄNH TI·ªÄN:</strong></span>
                        <strong id="grandTotal">0 VNƒê</strong>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" id="paymentBtn" onclick="processPayment()" disabled>
                            <i class="fas fa-credit-card"></i> Thanh To√°n
                        </button>
                        <button class="btn btn-outline-light" onclick="clearCart()">
                            <i class="fas fa-trash"></i> X√≥a Gi·ªè H√†ng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Management Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-users"></i> Qu·∫£n L√Ω Kh√°ch H√†ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Search Customer Section -->
                    <div class="mb-4">
                        <h6><i class="fas fa-search"></i> T√¨m Kh√°ch H√†ng</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="searchCustomerInput" 
                                       placeholder="Nh·∫≠p t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i...">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="searchExistingCustomers()">
                                    <i class="fas fa-search"></i> T√¨m
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="loadAllCustomers()">
                                    <i class="fas fa-list"></i> T·∫•t c·∫£
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="searchResults" class="mt-3" style="display: none;">
                            <h6>K·∫øt qu·∫£ t√¨m ki·∫øm:</h6>
                            <div id="customerList" class="list-group" style="max-height: 200px; overflow-y: auto;">
                                <!-- Search results will be populated here -->
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- New Customer Section -->
                    <div class="mb-4">
                        <h6><i class="fas fa-user-plus"></i> Th√™m Kh√°ch H√†ng M·ªõi</h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <input type="text" class="form-control" id="customerName" placeholder="T√™n kh√°ch h√†ng (b·∫Øt bu·ªôc)">
                            </div>
                            <div class="col-md-6 mb-2">
                                <input type="tel" class="form-control" id="customerPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i (b·∫Øt bu·ªôc)">
                            </div>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="customerAddress" placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt (s·ªë nh√†, ƒë∆∞·ªùng) - t√πy ch·ªçn">
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 mb-2">
                                <select class="form-control" id="customerCity" onchange="updateDistricts()">
                                    <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
                                    <option value="H√† N·ªôi">H√† N·ªôi</option>
                                    <option value="H·ªì Ch√≠ Minh">H·ªì Ch√≠ Minh</option>
                                    <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                                    <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                                    <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <input type="text" class="form-control" id="customerWard" placeholder="Ph∆∞·ªùng/x√£ - t√πy ch·ªçn">
                            </div>
                            <div class="col-md-4 mb-2">
                                <select class="form-control" id="customerDistrict">
                                    <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6 mb-2">
                                <input type="date" class="form-control" id="customerDob" placeholder="Ng√†y sinh - t√πy ch·ªçn">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="selectGuestCustomer()">
                        <i class="fas fa-user"></i> Kh√°ch L·∫ª
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveAndSelectCustomer()">
                        <i class="fas fa-check"></i> Ch·ªçn/T·∫°o Kh√°ch H√†ng
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle"></i> Thanh To√°n Th√†nh C√¥ng
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h4>ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</h4>
                    <p class="text-muted">M√£ ƒë∆°n h√†ng: <strong id="orderId">#001</strong></p>
                    <p class="text-muted">T·ªïng ti·ªÅn: <strong id="orderTotal">0 VNƒê</strong></p>
                    <p class="text-muted">Kh√°ch h√†ng: <strong id="orderCustomer">N/A</strong></p>
                    <div id="vipOrderNotice" class="alert alert-info" style="display: none;">
                        <i class="fas fa-crown"></i> Y√™u c·∫ßu VIP ƒë√£ ƒë∆∞·ª£c t·∫°o v√† ƒëang ch·ªù admin x√°c nh·∫≠n!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="printReceipt()">
                        <i class="fas fa-print"></i> In H√≥a ƒê∆°n
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetPOS()">
                        <i class="fas fa-plus"></i> ƒê∆°n H√†ng M·ªõi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body text-center py-4 bg-light">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <div class="spinner-grow text-primary me-2" role="status" style="width: 1.5rem; height: 1.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow text-success me-2" role="status" style="width: 1.5rem; height: 1.5rem; animation-delay: 0.2s;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow text-warning" role="status" style="width: 1.5rem; height: 1.5rem; animation-delay: 0.4s;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h6 class="text-muted mb-0">ƒêang x·ª≠ l√Ω...</h6>
                    <small class="text-muted">Vui l√≤ng ƒë·ª£i</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quantity Input Modal -->
    <div class="modal fade" id="quantityModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-sort-numeric-up"></i> Nh·∫≠p S·ªë L∆∞·ª£ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong id="selectedProductName">S·∫£n ph·∫©m</strong></p>
                    <p class="text-muted">C√≤n l·∫°i: <span id="selectedProductStock">0</span></p>
                    <div class="mb-3">
                        <label for="quantityInput" class="form-label">S·ªë l∆∞·ª£ng:</label>
                        <input type="number" class="form-control form-control-lg text-center" 
                               id="quantityInput" min="1" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmAddToCart()">
                        <i class="fas fa-check"></i> Th√™m V√†o Gi·ªè
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form id="checkoutForm" action="/user/pos/payment" method="post" style="display: none;">
        <input type="hidden" name="customerId" id="customerIdInput">
        <input type="hidden" name="customerName" id="customerNameInput">
        <input type="hidden" name="customerPhone" id="customerPhoneInput">
        <input type="hidden" name="customerAddress" id="customerAddressInput">
        <input type="hidden" name="customerWard" id="customerWardInput">
        <input type="hidden" name="customerDistrict" id="customerDistrictInput">
        <input type="hidden" name="customerProvince" id="customerProvinceInput">
        <input type="hidden" name="customerDob" id="customerDobInput">
        <input type="hidden" name="cartData" id="cartDataInput">
        <input type="hidden" name="customerData" id="customerDataInput">
        <input type="hidden" name="createVipRequest" id="createVipRequestInput" value="false">
    </form>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let cart = [];
        let selectedCustomer = null;
        let currentProductForQuantity = null;

        // Data for Vietnamese provinces and districts
        const vietnamData = {
            "H√† N·ªôi": ["Ba ƒê√¨nh", "Ho√†n Ki·∫øm", "Hai B√† Tr∆∞ng", "ƒê·ªëng ƒêa", "T√¢y H·ªì", "C·∫ßu Gi·∫•y", "Thanh Xu√¢n", "Ho√†ng Mai", "Long Bi√™n", "H√† ƒê√¥ng", "B·∫Øc T·ª´ Li√™m", "Nam T·ª´ Li√™m"],
            "H·ªì Ch√≠ Minh": ["Qu·∫≠n 1", "Qu·∫≠n 2", "Qu·∫≠n 3", "Qu·∫≠n 4", "Qu·∫≠n 5", "Qu·∫≠n 6", "Qu·∫≠n 7", "Qu·∫≠n 8", "Qu·∫≠n 9", "Qu·∫≠n 10", "Qu·∫≠n 11", "Qu·∫≠n 12", "B√¨nh T√¢n", "B√¨nh Th·∫°nh", "G√≤ V·∫•p", "Ph√∫ Nhu·∫≠n", "T√¢n B√¨nh", "T√¢n Ph√∫", "Th·ªß ƒê·ª©c"],
            "ƒê√† N·∫µng": ["H·∫£i Ch√¢u", "Thanh Kh√™", "S∆°n Tr√†", "Ng≈© H√†nh S∆°n", "Li√™n Chi·ªÉu", "C·∫©m L·ªá", "H√≤a Vang"],
            "H·∫£i Ph√≤ng": ["H·ªìng B√†ng", "Ng√¥ Quy·ªÅn", "L√™ Ch√¢n", "H·∫£i An", "Ki·∫øn An", "ƒê·ªì S∆°n", "D∆∞∆°ng Kinh", "Th·ªßy Nguy√™n", "An D∆∞∆°ng", "An L√£o", "Ki·∫øn Th·ª•y", "Ti√™n L√£ng", "Vƒ©nh B·∫£o", "C√°t H·∫£i"],
            "C·∫ßn Th∆°": ["Ninh Ki·ªÅu", "B√¨nh Th·ªßy", "C√°i RƒÉng", "√î M√¥n", "Th·ªët N·ªët"]
        };

        // Function to update districts based on selected city
        function updateDistricts() {
            const citySelect = document.getElementById('customerCity');
            const districtSelect = document.getElementById('customerDistrict');
            const selectedCity = citySelect.value;
            
            // Clear current districts
            districtSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
            
            if (selectedCity && vietnamData[selectedCity]) {
                vietnamData[selectedCity].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        // H√†m t·∫£i danh m·ª•c t·ª´ database
        function loadCategoriesFromDB() {
            fetch('/user/pos/categories')
                .then(response => response.json())
                .then(categories => {
                    const categoryContainer = document.getElementById('categoryContainer');
                    categoryContainer.innerHTML = `
                        <button class="btn btn-outline-primary category-btn active" 
                                onclick="filterByCategory('', this)" data-category="">
                            <i class="fas fa-th-large"></i> T·∫•t c·∫£
                        </button>
                    `;
                    categories.forEach(cat => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline-primary category-btn';
                        btn.setAttribute('data-category', cat);
                        btn.onclick = () => filterByCategory(cat, btn);
                        btn.innerHTML = `<i class="fas fa-tag"></i> ${cat}`;
                        categoryContainer.appendChild(btn);
                    });
                })
                .catch(error => {
                    console.error('L·ªói t·∫£i danh m·ª•c:', error);
                    showAlert('Kh√¥ng th·ªÉ t·∫£i danh m·ª•c t·ª´ database!', 'error');
                });
        }

        function loadAllProducts() {
            fetch('/user/pos/products')
                .then(res => res.json())
                .then(products => renderProducts(products))
                .catch(error => showAlert('L·ªói t·∫£i s·∫£n ph·∫©m!', 'error'));
        }

        // G·ªçi h√†m khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadCategoriesFromDB();
            loadAllProducts();
            updateCartDisplay();
        });

        // ==================== PRODUCT FUNCTIONS ====================

        // Select product (click on product card)
        function selectProduct(productCard) {
            if (productCard.closest('.out-of-stock')) {
                showAlert('S·∫£n ph·∫©m n√†y ƒë√£ h·∫øt h√†ng!', 'warning');
                return;
            }
            
            const productId = productCard.getAttribute('data-product-id');
            const productName = productCard.getAttribute('data-product-name');
            const productPrice = parseFloat(productCard.getAttribute('data-product-price'));
            const productQuantity = parseInt(productCard.getAttribute('data-product-quantity'));
            
            if (productQuantity <= 0) {
                showAlert('S·∫£n ph·∫©m n√†y ƒë√£ h·∫øt h√†ng!', 'warning');
                return;
            }
            
            // Show quantity modal
            currentProductForQuantity = {
                id: productId,
                name: productName,
                price: productPrice,
                availableQuantity: productQuantity
            };
            
            document.getElementById('selectedProductName').textContent = productName;
            document.getElementById('selectedProductStock').textContent = productQuantity;
            document.getElementById('quantityInput').value = 1;
            document.getElementById('quantityInput').max = productQuantity;
            
            const quantityModal = new bootstrap.Modal(document.getElementById('quantityModal'));
            quantityModal.show();
        }

        // Add to cart from product card (quick add +1)
        function addToCartFromCard(productCard) {
            if (productCard.closest('.out-of-stock')) {
                showAlert('S·∫£n ph·∫©m n√†y ƒë√£ h·∫øt h√†ng!', 'warning');
                return;
            }
            
            const product = {
                id: productCard.getAttribute('data-product-id'),
                name: productCard.getAttribute('data-product-name'),
                price: parseFloat(productCard.getAttribute('data-product-price')),
                availableQuantity: parseInt(productCard.getAttribute('data-product-quantity'))
            };
            
            if (product.availableQuantity <= 0) {
                showAlert('S·∫£n ph·∫©m n√†y ƒë√£ h·∫øt h√†ng!', 'warning');
                return;
            }
            
            addToCart(product, 1);
        }

        // Confirm add to cart from quantity modal
        function confirmAddToCart() {
            if (!currentProductForQuantity) return;
            
            const quantity = parseInt(document.getElementById('quantityInput').value);
            
            if (quantity <= 0 || quantity > currentProductForQuantity.availableQuantity) {
                showAlert(`S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá! T·ªëi ƒëa: ${currentProductForQuantity.availableQuantity}`, 'warning');
                return;
            }
            
            addToCart(currentProductForQuantity, quantity);
            
            // Close modal
            const quantityModal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
            quantityModal.hide();
            currentProductForQuantity = null;
        }

        // Add product to cart
        function addToCart(product, quantity) {
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                const newQuantity = existingItem.quantity + quantity;
                if (newQuantity > product.availableQuantity) {
                    showAlert(`Kh√¥ng ƒë·ªß h√†ng! T·ªëi ƒëa: ${product.availableQuantity}`, 'warning');
                    return;
                }
                existingItem.quantity = newQuantity;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: quantity,
                    total: product.price * quantity,
                    availableQuantity: product.availableQuantity
                });
            }
            
            updateCartDisplay();
            showAlert(`ƒê√£ th√™m ${product.name} v√†o gi·ªè h√†ng!`, 'success');
        }

        // Update cart quantity
        function updateCartQuantity(productId, newQuantity) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            if (newQuantity > item.availableQuantity) {
                showAlert(`Kh√¥ng ƒë·ªß h√†ng! T·ªëi ƒëa: ${item.availableQuantity}`, 'warning');
                return;
            }
            
            item.quantity = newQuantity;
            item.total = item.quantity * item.price;
            updateCartDisplay();
        }

        // Remove from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
            showAlert('ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng!', 'info');
        }

        // Clear cart
        function clearCart() {
            if (cart.length === 0) {
                showAlert('Gi·ªè h√†ng ƒë√£ tr·ªëng!', 'info');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng?')) {
                cart = [];
                updateCartDisplay();
                showAlert('ƒê√£ x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m!', 'info');
            }
        }

        // Update cart display
        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cartItems');
            const cartItemCount = document.getElementById('cartItemCount');
            const totalItems = document.getElementById('totalItems');
            const subtotal = document.getElementById('subtotal');
            const vipDiscount = document.getElementById('vipDiscount');
            const grandTotal = document.getElementById('grandTotal');
            const paymentBtn = document.getElementById('paymentBtn');
            
            // Update item count
            const totalItemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartItemCount.textContent = totalItemCount;
            totalItems.textContent = totalItemCount;
            
            // Update cart items display
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-shopping-cart fa-2x"></i>
                        <p class="mt-2">Gi·ªè h√†ng tr·ªëng</p>
                        <small>Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o gi·ªè</small>
                    </div>
                `;
            } else {
                cartItemsContainer.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${item.name}</h6>
                                <small class="text-muted">${formatCurrency(item.price)} x ${item.quantity}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity - 1})">-</button>
                                <span class="mx-2 fw-bold">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity + 1})">+</button>
                            </div>
                            <strong class="text-success">${formatCurrency(item.total)}</strong>
                        </div>
                    </div>
                `).join('');
            }
            
            // Calculate totals
            const subtotalAmount = cart.reduce((sum, item) => sum + item.total, 0);
            let vipDiscountAmount = 0;
            let finalAmount = subtotalAmount;
            
            // Apply VIP discount if customer is VIP
            if (selectedCustomer && selectedCustomer.vip && selectedCustomer.vipDiscountPercent > 0) {
                vipDiscountAmount = subtotalAmount * (selectedCustomer.vipDiscountPercent / 100);
                finalAmount = subtotalAmount - vipDiscountAmount;
            }
            
            // Update display
            subtotal.textContent = formatCurrency(subtotalAmount);
            vipDiscount.textContent = vipDiscountAmount > 0 ? '-' + formatCurrency(vipDiscountAmount) : '0 VNƒê';
            grandTotal.textContent = formatCurrency(finalAmount);
            
            // Enable/disable payment button
            paymentBtn.disabled = cart.length === 0;
        }

        // ==================== CUSTOMER FUNCTIONS ====================

        // Toggle customer modal
        function toggleCustomerModal() {
            const modal = new bootstrap.Modal(document.getElementById('customerModal'));
            modal.show();
        }

        // Search existing customers
        function searchExistingCustomers() {
            const searchTerm = document.getElementById('searchCustomerInput').value.trim();
            
            if (searchTerm.length < 2) {
                showAlert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm!', 'warning');
                return;
            }
            
            // Call API to search customers
            fetch(`/user/pos/customer/search?query=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(customers => {
                    displayCustomerSearchResults(customers);
                })
                .catch(error => {
                    console.error('Error searching customers:', error);
                    showAlert('C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm kh√°ch h√†ng!', 'error');
                });
        }

        // Load all customers
        function loadAllCustomers() {
            fetch('/user/pos/customer/all')
                .then(response => response.json())
                .then(customers => {
                    displayCustomerSearchResults(customers.slice(0, 20)); // Limit to 20 results
                })
                .catch(error => {
                    console.error('Error loading customers:', error);
                    showAlert('C√≥ l·ªói x·∫£y ra khi t·∫£i danh s√°ch kh√°ch h√†ng!', 'error');
                });
        }

        // Display customer search results
        // Display customer search results
function displayCustomerSearchResults(customers) {
    const searchResults = document.getElementById('searchResults');
    const customerList = document.getElementById('customerList');
    
    if (customers.length === 0) {
        customerList.innerHTML = '<div class="list-group-item text-muted">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng n√†o</div>';
    } else {
        customerList.innerHTML = customers.map(customer => {
            const vipBadge = customer.vip ? '<span class="badge bg-warning ms-2">VIP</span>' : '';
            const pendingBadge = customer.pendingVip ? '<span class="badge bg-info ms-2">Ch·ªù duy·ªát</span>' : '';
            
            // Format date properly
            let dobStr = 'null';
            if (customer.dateOfBirth) {
                if (Array.isArray(customer.dateOfBirth)) {
                    dobStr = `${customer.dateOfBirth[0]}-${String(customer.dateOfBirth[1]).padStart(2, '0')}-${String(customer.dateOfBirth[2]).padStart(2, '0')}`;
                } else {
                    dobStr = customer.dateOfBirth;
                }
            }
            
            return `
                <div class="list-group-item list-group-item-action" onclick="selectExistingCustomer('${customer.id}', '${customer.name}', '${customer.phone || ''}', '${customer.address || ''}', '${customer.ward || ''}', '${customer.district || ''}', '${customer.province || ''}', '${dobStr}', ${customer.vip}, ${customer.vipDiscountPercent || 0}, ${customer.pendingVip})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${customer.name} ${vipBadge} ${pendingBadge}</h6>
                            <small class="text-muted">${customer.phone || 'Ch∆∞a c√≥ SƒêT'}</small>
                            ${customer.dateOfBirth ? `<br><small class="text-info">Sinh: ${formatDateDisplay(customer.dateOfBirth)}</small>` : ''}
                        </div>
                        <small class="text-muted">Ch·ªçn</small>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    searchResults.style.display = 'block';
}


// Add this function before the existing functions
function formatDateDisplay(dateValue) {
    if (!dateValue) return '';
    
    if (Array.isArray(dateValue) && dateValue.length >= 3) {
        return `${String(dateValue[2]).padStart(2, '0')}/${String(dateValue[1]).padStart(2, '0')}/${dateValue[0]}`;
    } else if (typeof dateValue === 'string') {
        try {
            const date = new Date(dateValue);
            return date.toLocaleDateString('vi-VN');
        } catch (e) {
            return dateValue;
        }
    }
    return dateValue;
}
        // Select existing customer from search results
function selectExistingCustomer(id, name, phone, address, ward, district, province, dateOfBirth, isVip, vipDiscountPercent, isPendingVip) {
    let dob = dateOfBirth;
    if (dob && /^\d{4}-\d{2}-\d{2}$/.test(dob)) {
        const [y, m, d] = dob.split('-');
        dob = `${d}/${m}/${y}`;
    }
    selectedCustomer = {
        id: id,
        name: name,
        phone: phone,
        address: address,
        ward: ward,
        district: district,
        province: province,
        dateOfBirth: dob && dob !== 'null' && dob !== '' ? dob : null,
        vip: isVip,
        vipDiscountPercent: vipDiscountPercent || 0,
        pendingVip: isPendingVip || false
    };
    updateCustomerDisplay();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
    modal.hide();
    
    showAlert(`ƒê√£ ch·ªçn kh√°ch h√†ng: ${name}`, 'success');
}
        // Select guest customer
        function selectGuestCustomer() {
            selectedCustomer = null;
            updateCustomerDisplay();

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
            modal.hide();

            showAlert('ƒê√£ ch·ªçn kh√°ch l·∫ª', 'info');
        }

        // Save and select customer
        function saveAndSelectCustomer() {
            const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const address = document.getElementById('customerAddress').value.trim();
    const ward = document.getElementById('customerWard').value.trim();
    const district = document.getElementById('customerDistrict').value.trim();
    const city = document.getElementById('customerCity').value.trim();
    let dob = document.getElementById('customerDob').value;

    // Convert yyyy-MM-dd (input type="date") to dd/MM/yyyy
    if (dob && /^\d{4}-\d{2}-\d{2}$/.test(dob)) {
        const [y, m, d] = dob.split('-');
        dob = `${d}/${m}/${y}`;
    }

            // Ki·ªÉm tra th√¥ng tin b·∫Øt bu·ªôc
            if (!name) {
                showAlert('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!', 'warning');
                return;
            }
            if (!phone || phone.length < 10) {
                showAlert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (√≠t nh·∫•t 10 s·ªë)!', 'warning');
                return;
            }

            // Call API to create customer
            fetch('/user/pos/customer/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `fullName=${encodeURIComponent(name)}&phoneNumber=${encodeURIComponent(phone)}&address=${encodeURIComponent(address)}&ward=${encodeURIComponent(ward)}&district=${encodeURIComponent(district)}&province=${encodeURIComponent(city)}&dob=${encodeURIComponent(dob)}`
    })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const customer = result.customer;
                    selectedCustomer = {
                        id: customer.id,
                        name: customer.name,
                        phone: customer.phone,
                        address: customer.address || '',
                        ward: customer.ward || '',
                        district: customer.district || '',
                        province: customer.province || '',
                        dateOfBirth: customer.dateOfBirth || '',
                        vip: customer.vip || false,
                        vipDiscountPercent: customer.vipDiscountPercent || 0,
                        pendingVip: customer.pendingVip || false
                    };
                    
                    updateCustomerDisplay();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
                    modal.hide();
                    
                    showAlert(`ƒê√£ t·∫°o v√† ch·ªçn kh√°ch h√†ng: ${customer.name}`, 'success');
                    
                    // Clear form
                    clearCustomerForm();
                } else {
                    showAlert(result.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o kh√°ch h√†ng!', 'error');
                }
            })
            .catch(error => {
                console.error('Error creating customer:', error);
                showAlert('C√≥ l·ªói x·∫£y ra khi t·∫°o kh√°ch h√†ng!', 'error');
            });
        }

        // Clear customer form
        function clearCustomerForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerWard').value = '';
            document.getElementById('customerCity').value = '';
            document.getElementById('customerDistrict').innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
            document.getElementById('customerDob').value = '';
        }

        // Update customer display
        function updateCustomerDisplay() {
            const customerInfoCompact = document.getElementById('customerInfoCompact');
            const customerNameDisplay = document.getElementById('customerNameDisplay');
            const customerPhoneDisplay = document.getElementById('customerPhoneDisplay');
            const vipBadge = document.getElementById('vipBadge');
            const pendingVipBadge = document.getElementById('pendingVipBadge');
            
            if (selectedCustomer) {
                customerInfoCompact.style.display = 'block';
                customerNameDisplay.textContent = selectedCustomer.name;
                customerPhoneDisplay.textContent = selectedCustomer.phone || '';
                
                // Show VIP badge
                if (selectedCustomer.vip) {
                    vipBadge.style.display = 'inline';
                    vipBadge.textContent = `VIP -${selectedCustomer.vipDiscountPercent}%`;
                    pendingVipBadge.style.display = 'none';
                } else if (selectedCustomer.pendingVip) {
                    vipBadge.style.display = 'none';
                    pendingVipBadge.style.display = 'inline';
                } else {
                    vipBadge.style.display = 'none';
                    pendingVipBadge.style.display = 'none';
                }
            } else {
                customerInfoCompact.style.display = 'none';
            }
            
            // Update cart display to recalculate VIP discount
            updateCartDisplay();
        }

        // ==================== PAYMENT FUNCTIONS ====================

        // Process payment
        function processPayment() {
    const paymentBtn = document.getElementById('paymentBtn');

    // Ch·∫∑n double submit
    if (paymentBtn.disabled) return;
    paymentBtn.disabled = true;

    // Ki·ªÉm tra gi·ªè h√†ng
    if (cart.length === 0) {
        showAlert('Gi·ªè h√†ng tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.', 'warning');
        paymentBtn.disabled = false;
        return;
    }

    // Chu·∫©n h√≥a ng√†y sinh
    let dobValue = '';
if (selectedCustomer && selectedCustomer.dateOfBirth) {
    // Gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng dd/MM/yyyy
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(selectedCustomer.dateOfBirth)) {
        // ƒê√£ ƒë√∫ng ƒë·ªãnh d·∫°ng dd/MM/yyyy
        dobValue = selectedCustomer.dateOfBirth;
    } else if (/^\d{4}-\d{2}-\d{2}$/.test(selectedCustomer.dateOfBirth)) {
        // Chuy·ªÉn t·ª´ yyyy-MM-dd sang dd/MM/yyyy
        const [y, m, d] = selectedCustomer.dateOfBirth.split('-');
        dobValue = `${d}/${m}/${y}`;
    } else if (Array.isArray(selectedCustomer.dateOfBirth) && selectedCustomer.dateOfBirth.length >= 3) {
        // Chuy·ªÉn t·ª´ array [yyyy, mm, dd] sang dd/MM/yyyy
        dobValue = `${String(selectedCustomer.dateOfBirth[2]).padStart(2, '0')}/${String(selectedCustomer.dateOfBirth[1]).padStart(2, '0')}/${selectedCustomer.dateOfBirth[0]}`;
    } else if (typeof selectedCustomer.dateOfBirth === 'string') {
        // Th·ª≠ parse ISO string v√† chuy·ªÉn sang dd/MM/yyyy
        const d = new Date(selectedCustomer.dateOfBirth);
        if (!isNaN(d)) {
            dobValue = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        } else {
            dobValue = selectedCustomer.dateOfBirth;
        }
    }
}

    // Fill form data
    if (selectedCustomer) {
        document.getElementById('customerIdInput').value = selectedCustomer.id || '';
        document.getElementById('customerNameInput').value = selectedCustomer.name || '';
        document.getElementById('customerPhoneInput').value = selectedCustomer.phone || '';
        document.getElementById('customerAddressInput').value = selectedCustomer.address || '';
        document.getElementById('customerWardInput').value = selectedCustomer.ward || '';
        document.getElementById('customerDistrictInput').value = selectedCustomer.district || '';
        document.getElementById('customerProvinceInput').value = selectedCustomer.province || '';
        document.getElementById('customerDobInput').value = dobValue;
        document.getElementById('customerDataInput').value = JSON.stringify({
            ...selectedCustomer,
            dateOfBirth: dobValue
        });
    } else {
        // Kh√°ch l·∫ª
        document.getElementById('customerIdInput').value = '';
        document.getElementById('customerNameInput').value = 'Kh√°ch l·∫ª';
        document.getElementById('customerPhoneInput').value = '';
        document.getElementById('customerAddressInput').value = '';
        document.getElementById('customerWardInput').value = '';
        document.getElementById('customerDistrictInput').value = '';
        document.getElementById('customerProvinceInput').value = '';
        document.getElementById('customerDobInput').value = '';
        document.getElementById('customerDataInput').value = JSON.stringify({
            id: null,
            name: 'Kh√°ch l·∫ª',
            phone: '',
            address: '',
            ward: '',
            district: '',
            province: '',
            dateOfBirth: '',
            vip: false,
            vipDiscountPercent: 0,
            pendingVip: false
        });
    }

    document.getElementById('cartDataInput').value = JSON.stringify(cart);

    // Check if should create VIP request
    const subtotalAmount = cart.reduce((sum, item) => sum + item.total, 0);
    const shouldCreateVipRequest = selectedCustomer &&
        selectedCustomer.id &&
        subtotalAmount >= 2000000 &&
        !selectedCustomer.vip &&
        !selectedCustomer.pendingVip;
    document.getElementById('createVipRequestInput').value = shouldCreateVipRequest ? 'true' : 'false';

    // Debug log
    console.log('Submit customer DOB:', dobValue);

    // Submit form ƒë·ªÉ chuy·ªÉn sang trang payment
    document.getElementById('checkoutForm').submit();
}
        // Reset POS for new order
        function resetPOS() {
            cart = [];
            selectedCustomer = null;
            updateCartDisplay();
            updateCustomerDisplay();
            
            // Clear search results
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchCustomerInput').value = '';
            clearCustomerForm();
        }

        // Print receipt
        function printReceipt() {
            window.print();
        }

        // ==================== SEARCH AND FILTER FUNCTIONS ====================

        // Category filter function
        function filterByCategory(category, buttonElement) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            buttonElement.classList.add('active');

            const resultCount = document.getElementById('searchResultCount');
            const noProductsDiv = document.getElementById('noProductsFound');

            if (category === '') {
                loadAllProducts();
                resultCount.style.display = 'none';
                noProductsDiv.style.display = 'none';
                return;
            }

            fetch(`/user/pos/search-by-category?category=${encodeURIComponent(category)}`)
                .then(res => res.json())
                .then(products => {
                    renderProducts(products);
                    resultCount.style.display = 'block';
                    resultCount.textContent = `T√¨m th·∫•y ${products.length} s·∫£n ph·∫©m trong danh m·ª•c "${category}"`;
                    if (products.length === 0) {
                        noProductsDiv.style.display = 'block';
                    } else {
                        noProductsDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    showAlert('L·ªói t·∫£i s·∫£n ph·∫©m theo danh m·ª•c!', 'error');
                });
        }

        // Render products
        function renderProducts(products) {
            const productGrid = document.getElementById('productGrid').querySelector('.row');
            productGrid.innerHTML = products.map(product => `
                <div class="col-md-3 product-item ${product.quantity <= 0 ? 'out-of-stock' : ''}" data-category="${product.category}">
                    <div class="card product-card h-100"
                        data-product-id="${product.id}"
                        data-product-name="${product.name}"
                        data-product-price="${product.price}"
                        data-product-quantity="${product.quantity}"
                        onclick="selectProduct(this)">
                        <div class="card-body text-center">
                            <i class="fas fa-box fa-2x text-primary mb-2"></i>
                            <h6 class="card-title">${product.name}</h6>
                            <p class="text-muted small mb-1">M√£: ${product.id}</p>
                            <p class="text-muted small mb-1">
                                <i class="fas fa-tags"></i> ${product.category || ''}
                            </p>
                            <h5 class="text-success mb-2">${formatCurrency(product.price)}</h5>
                            <div class="mb-2">
                                <span class="badge ${product.quantity > 0 ? 'bg-success' : 'bg-danger'}">C√≤n: ${product.quantity}</span>
                            </div>
                            ${product.quantity <= 0 ? '<div class="text-danger small"><i class="fas fa-exclamation-triangle"></i> H·∫øt h√†ng</div>' : ''}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); addToCartFromCard(this.parentElement.parentElement.parentElement)" ${product.quantity <= 0 ? 'disabled' : ''}>
                                    <i class="fas fa-plus"></i> +1
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Product search function
        function performProductSearch(searchTerm) {
            if (searchTerm.trim() === '') {
                clearSearch();
                return;
            }

            fetch(`/user/pos/search?query=${encodeURIComponent(searchTerm)}`)
                .then(res => res.json())
                .then(products => {
                    renderProducts(products);
                    
                    const resultCount = document.getElementById('searchResultCount');
                    const noProductsDiv = document.getElementById('noProductsFound');
                    
                    resultCount.style.display = 'block';
                    resultCount.textContent = `T√¨m th·∫•y ${products.length} s·∫£n ph·∫©m cho "${searchTerm}"`;
                    
                    if (products.length === 0) {
                        noProductsDiv.style.display = 'block';
                    } else {
                        noProductsDiv.style.display = 'none';
                    }
                    
                    // Reset category filter
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                })
                .catch(error => {
                    showAlert('L·ªói t√¨m ki·∫øm s·∫£n ph·∫©m!', 'error');
                });
        }

        // Clear search function
        function clearSearch() {
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchResultCount').style.display = 'none';
            document.getElementById('noProductsFound').style.display = 'none';
            
            // Load all products
            loadAllProducts();
            
            // Reset category filter
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.category-btn[data-category=""]').classList.add('active');
        }

        // ==================== UTILITY FUNCTIONS ====================

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount).replace('‚Ç´', 'VNƒê');
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            
            const alertIcon = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-triangle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            }[type] || 'fas fa-info-circle';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show error-alert`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                <i class="${alertIcon}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Handle keyboard shortcuts
    
        document.addEventListener('keydown', function(e) {

            if (e.key === 'F1') {
                e.preventDefault();
                toggleCustomerModal();
            }
            

            if (e.key === 'F2') {
                e.preventDefault();
                document.getElementById('searchProduct').focus();
            }
            

            if (e.key === 'F3') {
                e.preventDefault();
                clearCart();
            }
            

            if (e.key === 'Enter' && e.ctrlKey && cart.length > 0) {
                e.preventDefault();
                processPayment();
            }
        });
    </script>
</body>
</html>