<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết hóa đơn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-invoice"></i> Chi tiết hóa đơn: <strong th:text="${order.orderNumber}">POS-001</strong>
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Thông tin khách hàng và hóa đơn -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Thông tin khách hàng</h6>
                                <p><strong>Tên:</strong> <span th:text="${customer != null ? customer.name : 'Khách vãng lai'}">Khách lẻ</span></p>
                                <p><strong>SĐT:</strong> <span th:text="${customer != null and customer.phone != null ? customer.phone : ''}"></span></p>
                                <p><strong>VIP:</strong>
                                    <span th:if="${order.vipOrder}" class="badge bg-success">Có</span>
                                    <span th:unless="${order.vipOrder}" class="badge bg-secondary">Không</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>Thông tin hóa đơn</h6>
                                <p><strong>Mã hóa đơn:</strong> <span th:text="${order.orderNumber}">POS-001</span></p>
                                <p><strong>Ngày tạo:</strong> <span th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">23/10/2025 14:18</span></p>
                                <p><strong>Trạng thái:</strong>
                                    <span th:switch="${order.status != null ? order.status.name() : ''}">
                                        <span th:case="'RETURNED'" class="badge bg-info text-dark">Đã trả hàng</span>
                                        <span th:case="'COMPLETED'" class="badge bg-success">Hoàn thành</span>
                                        <span th:case="'PENDING'" class="badge bg-warning text-dark">Đang xử lý</span>
                                        <span th:case="'CANCELLED'" class="badge bg-danger">Đã hủy</span>
                                        <span th:case="*">Khác</span>
                                    </span>
                                </p>
                            </div>
                        </div>

                        <!-- Danh sách sản phẩm đã mua -->
                        <h6>Danh sách sản phẩm đã mua</h6>
                        <div class="table-responsive mb-4">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="item : ${orderItems}">
                                        <td th:text="${item.product != null ? item.product.name : 'Sản phẩm không xác định'}"></td>
                                        <td th:text="${item.quantity}"></td>
                                        <td th:text="|${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} VNĐ|"></td>
                                        <td th:text="|${#numbers.formatDecimal(item.quantity * item.price, 0, 'COMMA', 0, 'POINT')} VNĐ|"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Thông tin đổi trả -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-danger"><i class="fas fa-exchange-alt"></i> Sản phẩm đổi/trả</h6>
                                <div class="table-responsive mb-3">
                                    <table class="table table-bordered table-sm">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm muốn đổi</th>
                                                <th>Số lượng</th>
                                                <th>Đơn giá</th>
                                                <th>Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${returnItems}">
                                                <td th:text="${item.product != null ? item.product.name : 'Sản phẩm không xác định'}"></td>
                                                <td th:text="${item.quantity}"></td>
                                                <td th:text="|${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} VNĐ|"></td>
                                                <td th:text="|${#numbers.formatDecimal(item.quantity * item.unitPrice, 0, 'COMMA', 0, 'POINT')} VNĐ|"></td>
                                            </tr>
                                            <tr th:if="${returnItems == null or #lists.isEmpty(returnItems)}">
                                                <td colspan="4" class="text-center text-muted">Không có sản phẩm đổi/trả</td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th colspan="3" class="text-end">Tổng tiền sản phẩm đổi:</th>
                                                <th class="text-danger" th:text="|-${#numbers.formatDecimal(totalReturnAmount != null ? totalReturnAmount : 0, 0, 'COMMA', 0, 'POINT')} VNĐ|">-0 VNĐ</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success"><i class="fas fa-arrow-right-arrow-left"></i> Sản phẩm nhận sau đổi</h6>
                                <div class="table-responsive mb-3">
                                    <table class="table table-bordered table-sm">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm nhận</th>
                                                <th>Số lượng</th>
                                                <th>Đơn giá</th>
                                                <th>Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${receiveItems}">
                                                <td th:text="${item.product != null ? item.product.name : 'Sản phẩm không xác định'}"></td>
                                                <td th:text="${item.quantity}"></td>
                                                <td th:text="|${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} VNĐ|"></td>
                                                <td th:text="|${#numbers.formatDecimal(item.quantity * item.unitPrice, 0, 'COMMA', 0, 'POINT')} VNĐ|"></td>
                                            </tr>
                                            <tr th:if="${receiveItems == null or #lists.isEmpty(receiveItems)}">
                                                <td colspan="4" class="text-center text-muted">Không có sản phẩm nhận sau đổi</td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th colspan="3" class="text-end">Tổng tiền sản phẩm nhận:</th>
                                                <th class="text-success" th:text="|+${#numbers.formatDecimal(totalReceiveAmount != null ? totalReceiveAmount : 0, 0, 'COMMA', 0, 'POINT')} VNĐ|">+0 VNĐ</th>
                                            </tr>
                                            <tr th:if="${hasDiscount and receiveVipDiscount > 0}">
                                                <th colspan="3" class="text-end text-success">Giảm giá VIP cho sản phẩm nhận:</th>
                                                <th class="text-success" th:text="|-${#numbers.formatDecimal(receiveVipDiscount != null ? receiveVipDiscount : 0, 0, 'COMMA', 0, 'POINT')} VNĐ|">-0 VNĐ</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        
<!-- Tóm tắt thanh toán (hiển thị đúng các giá trị đã truyền từ controller) -->
<!-- ...existing code... -->
<div class="row mt-4">
    <div class="col-md-6 offset-md-6">
        <table class="table table-borderless">
            <tr>
                <td><strong>Tạm tính (giá trị hàng hóa gốc):</strong></td>
                <td class="text-end fw-bold" th:text="|${#numbers.formatDecimal(baseTotal, 0, 'COMMA', 0, 'POINT')} VNĐ|">0 VNĐ</td>
            </tr>
            <tr th:if="${hasDiscount and actualDiscount > 0}">
                <td><strong>Giảm giá VIP hóa đơn gốc:</strong></td>
                <td class="text-end text-success" th:text="|-${#numbers.formatDecimal(actualDiscount, 0, 'COMMA', 0, 'POINT')} VNĐ|">-0 VNĐ</td>
            </tr>
            <tr>
                <td><strong>Tổng tiền khách thanh toán ban đầu (đã giảm giá vip):</strong></td>
                <td class="text-end fw-bold" th:text="|${#numbers.formatDecimal(originalTotal, 0, 'COMMA', 0, 'POINT')} VNĐ|">0 VNĐ</td>
            </tr>
            <tr>
                <td><strong>Tiền sản phẩm đổi:</strong></td>
                <td class="text-end text-danger" th:text="|-${#numbers.formatDecimal(totalReturnAmount, 0, 'COMMA', 0, 'POINT')} VNĐ|">-0 VNĐ</td>
            </tr>
            <tr>
                <td><strong>Tiền sản phẩm nhận:</strong></td>
                <td class="text-end text-success" th:text="|+${#numbers.formatDecimal(totalReceiveAmount, 0, 'COMMA', 0, 'POINT')} VNĐ|">+0 VNĐ</td>
            </tr>
            <tr th:if="${hasDiscount and receiveVipDiscount > 0}">
                <td><strong>Giảm giá VIP cho sản phẩm nhận:</strong></td>
                <td class="text-end text-success" th:text="|-${#numbers.formatDecimal(receiveVipDiscount, 0, 'COMMA', 0, 'POINT')} VNĐ|">-0 VNĐ</td>
            </tr>
            <tr>
                <td><strong>Thành tiền sau đổi trả:</strong></td>
                <td class="text-end fw-bold text-primary" th:text="|${#numbers.formatDecimal(actualPaidAmount, 0, 'COMMA', 0, 'POINT')} VNĐ|">0 VNĐ</td>
            </tr>
            <tr>
                <td><strong>Phương thức thanh toán:</strong></td>
                <td class="text-end" th:text="${paymentMethodVN != null ? paymentMethodVN : 'Chưa xác định'}">Chưa xác định</td>
            </tr>
        </table>
    </div>
</div>
<!-- ...existing code... -->
                        <!-- Nút quay lại -->
                        <div class="text-center mt-4">
                            <a th:href="@{/admin/revenue}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Quay lại danh sách doanh thu
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>