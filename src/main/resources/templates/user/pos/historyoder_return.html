<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chi Tiết Hóa Đơn Đổi/Trả</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .invoice-box { max-width: 800px; margin: auto; padding: 30px; border: 1px solid #eee; background: #fff; }
        .invoice-title { margin-bottom: 24px; }
        .table th, .table td { vertical-align: middle; }
        @media print {
            .mt-4, .btn, .no-print { display: none !important; }
            .invoice-box { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>
<div class="invoice-box mt-4" id="invoiceContent">
    <div class="receipt-container" style="width:280px; font-size:12px; font-family:'Courier New', monospace; color:#000; line-height:1.4; font-weight:900;">
        <!-- HEADER -->
        <div style="text-align:center; margin-bottom:10px;">
            <div style="font-size:16px; font-weight:900; margin-bottom:4px;">CỬA HÀNG ABC MART</div>
            <div style="font-size:11px; font-weight:900;">123 Đường ABC, Quận XYZ, TP.HCM</div>
            <div style="font-size:11px; font-weight:900;">Hotline: 0123-456-789</div>
        </div>
        
        <div style="text-align:center; border-top:2px solid #000; border-bottom:2px solid #000; padding:4px 0; margin:8px 0;">
            <div style="font-size:14px; font-weight:900;">HÓA ĐƠN ĐỔI/TRẢ HÀNG</div>
        </div>

        <!-- ORDER INFO -->
        <div style="margin-bottom:8px; font-size:11px; font-weight:900;">
            <div>Số HĐ: <span th:text="${order.orderNumber}" style="font-weight:900;"></span></div>
            <div>Ngày: <span th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}" style="font-weight:900;"></span></div>
            <div>Thu ngân: <span th:text="${order.createdBy != null ? order.createdBy : 'Admin'}" style="font-weight:900;"></span></div>
        </div>

        <div style="border-top:2px dashed #000; margin:6px 0;"></div>

        <!-- CUSTOMER INFO -->
        <div style="margin-bottom:8px; font-size:11px; font-weight:900;">
            <div>Khách hàng: <span th:text="${order.customer != null ? order.customer.name : 'Khách lẻ'}" style="font-weight:900;"></span></div>
            <div th:if="${order.customer != null && order.customer.phone != null && !order.customer.phone.isEmpty()}">
                SĐT: <span th:text="${order.customer.phone}" style="font-weight:900;"></span>
            </div>
            <div th:if="${order.customer != null}">
                <span th:if="${order.customer.address != null && !order.customer.address.isEmpty()}">
                    Địa chỉ: <span th:text="${order.customer.address}"></span>
                    <span th:if="${order.customer.ward != null && !order.customer.ward.isEmpty()}">, <span th:text="${order.customer.ward}"></span></span>
                    <span th:if="${order.customer.district != null && !order.customer.district.isEmpty()}">, <span th:text="${order.customer.district}"></span></span>
                    <span th:if="${order.customer.province != null && !order.customer.province.isEmpty()}">, <span th:text="${order.customer.province}"></span></span>
                </span>
            </div>
            <div th:if="${order.customer != null && order.customer.dateOfBirth != null}">
                Ngày sinh: <span th:text="${#temporals.format(order.customer.dateOfBirth, 'dd/MM/yyyy')}" style="font-weight:900;"></span>
            </div>
            <div th:if="${order.customer != null}">
                <span>Loại: </span>
                <span style="font-weight:900;" 
                      th:text="${order.customer.isVip != null && order.customer.isVip ? 'VIP' : 'Thường'}"></span>
            </div>
        </div>

        <div style="border-top:2px dashed #000; margin:6px 0;"></div>

        <!-- RETURNED ITEMS TABLE -->
        <div style="font-size:11px; font-weight:900; margin-bottom:4px;">Sản phẩm trả lại:</div>
        <table style="width:100%; font-size:11px; border-collapse:collapse; font-weight:900;">
            <thead>
                <tr style="border-bottom:2px solid #000;">
                    <th style="text-align:left; padding:2px 0; font-weight:900;">Tên sản phẩm</th>
                    <th style="text-align:right; padding:2px 0; font-weight:900; width:60px;">Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${returnItems}">
                    <td style="padding:2px 0; font-weight:900;">
                        <div style="font-weight:900;" th:text="${item.product != null ? item.product.name : item.name}"></div>
                        <div style="font-size:10px; color:#000; font-weight:900;">
                            <span th:text="${item.quantity}"></span> x 
                            <span th:text="${#numbers.formatDecimal(item.unitPrice != null ? item.unitPrice : item.price, 0, 'COMMA', 0, 'POINT')}"></span>đ
                        </div>
                    </td>
                    <td style="text-align:right; padding:2px 0; font-weight:900;">
                        <span th:text="${#numbers.formatDecimal(item.quantity * (item.unitPrice != null ? item.unitPrice : item.price), 0, 'COMMA', 0, 'POINT')}"></span>đ
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(returnItems)}">
                    <td colspan="2" class="text-center text-muted">Không có sản phẩm trả lại</td>
                </tr>
            </tbody>
        </table>

        <div style="border-top:2px dashed #000; margin:6px 0;"></div>

        <!-- RECEIVED ITEMS TABLE -->
        <div style="font-size:11px; font-weight:900; margin-bottom:4px;">Sản phẩm nhận sau đổi:</div>
        <table style="width:100%; font-size:11px; border-collapse:collapse; font-weight:900;">
            <thead>
                <tr style="border-bottom:2px solid #000;">
                    <th style="text-align:left; padding:2px 0; font-weight:900;">Tên sản phẩm</th>
                    <th style="text-align:right; padding:2px 0; font-weight:900; width:60px;">Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${receiveItems}">
                    <td style="padding:2px 0; font-weight:900;">
                        <div style="font-weight:900;" th:text="${item.product != null ? item.product.name : item.name}"></div>
                        <div style="font-size:10px; color:#000; font-weight:900;">
                            <span th:text="${item.quantity}"></span> x 
                            <span th:text="${#numbers.formatDecimal(item.unitPrice != null ? item.unitPrice : item.price, 0, 'COMMA', 0, 'POINT')}"></span>đ
                        </div>
                    </td>
                    <td style="text-align:right; padding:2px 0; font-weight:900;">
                        <span th:text="${#numbers.formatDecimal(item.quantity * (item.unitPrice != null ? item.unitPrice : item.price), 0, 'COMMA', 0, 'POINT')}"></span>đ
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(receiveItems)}">
                    <td colspan="2" class="text-center text-muted">Không có sản phẩm nhận sau đổi</td>
                </tr>
            </tbody>
        </table>

        <div style="border-top:2px dashed #000; margin:6px 0;"></div>

        <!-- REMAINING ITEMS TABLE -->
        <div style="font-size:11px; font-weight:900; margin-bottom:4px; margin-top:8px;">Tổng hợp sản phẩm còn lại sau đổi trả:</div>
        <table style="width:100%; font-size:11px; border-collapse:collapse; font-weight:900;">
            <thead>
                <tr style="border-bottom:2px solid #000;">
                    <th style="text-align:left; padding:2px 0; font-weight:900;">Tên sản phẩm</th>
                    <th style="text-align:center; padding:2px 0; font-weight:900; width:30px;">SL</th>
                    <th style="text-align:right; padding:2px 0; font-weight:900; width:60px;">Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${remainingItems}">
                    <td style="padding:2px 0; font-weight:900;" th:text="${item.name}"></td>
                    <td style="text-align:center; padding:2px 0; font-weight:900;" th:text="${item.quantity}"></td>
                    <td style="text-align:right; padding:2px 0; font-weight:900;">
                        <span th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')}"></span>đ
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(remainingItems)}">
                    <td colspan="3" class="text-center text-muted">Không còn sản phẩm nào</td>
                </tr>
            </tbody>
        </table>

        <div style="border-top:2px solid #000; margin:6px 0;"></div>

        <!-- TOTALS -->
        <!-- ...existing code... -->
<!-- ...existing code... -->
<div style="font-size:11px; font-weight:900;">
    <div style="display:flex; justify-content:space-between;">
        <span>Tạm tính (giá trị hàng hóa gốc):</span>
        <span style="font-weight:900;">
            <span th:text="${#numbers.formatDecimal(baseTotal, 0, 'COMMA', 0, 'POINT')}"></span>đ
        </span>
    </div>
    <div th:if="${actualDiscount != null && actualDiscount > 0}" style="display:flex; justify-content:space-between;">
        <span>Giảm giá VIP hóa đơn gốc:</span>
        <span style="font-weight:900; color:#198754;">
            -<span th:text="${#numbers.formatDecimal(actualDiscount, 0, 'COMMA', 0, 'POINT')}"></span>đ
        </span>
    </div>
    <div style="display:flex; justify-content:space-between;">
        <span>Tạm tính (hóa đơn gốc đã giảm giá):</span>
        <span style="font-weight:900;">
            <span th:text="${#numbers.formatDecimal(originalTotal, 0, 'COMMA', 0, 'POINT')}"></span>đ
        </span>
    </div>
    <div style="display:flex; justify-content:space-between;">
        <span>Tiền sản phẩm trả:</span>
        <span style="font-weight:900; color:#d00;">
            -<span th:text="${#numbers.formatDecimal(totalReturnAmount, 0, 'COMMA', 0, 'POINT')}"></span>đ
        </span>
    </div>
    <div style="display:flex; justify-content:space-between;">
        <span>Tiền sản phẩm nhận:</span>
        <span style="font-weight:900; color:#090;">
            +<span th:text="${#numbers.formatDecimal(totalReceiveAmount, 0, 'COMMA', 0, 'POINT')}"></span>đ
        </span>
    </div>
    <div th:if="${receiveVipDiscount != null && receiveVipDiscount > 0}" style="display:flex; justify-content:space-between;">
        <span>Giảm giá VIP cho sản phẩm nhận:</span>
        <span style="font-weight:900; color:#198754;">
            -<span th:text="${#numbers.formatDecimal(receiveVipDiscount, 0, 'COMMA', 0, 'POINT')}"></span>đ
        </span>
    </div>
    <div style="border-top:2px dashed #000; margin:4px 0;"></div>
    <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:900;">
        <span>TỔNG CỘNG (sau đổi trả):</span>
        <span>
            <span th:text="${#numbers.formatDecimal(actualPaidAmount, 0, 'COMMA', 0, 'POINT')}"></span>đ
        </span>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:2px; font-weight:900;">
        <span>Thanh toán:</span>
        <span style="font-weight:900;">
            <span th:text="${paymentMethodVN != null ? paymentMethodVN : 'Chưa xác định'}"></span>
        </span>
    </div>
</div>
<!-- ...existing code... -->
<!-- ...existing code... -->
        <div style="border-top:2px solid #000; margin:8px 0;"></div>

        <!-- QUY ĐỊNH ĐỔI TRẢ CHI TIẾT -->
        <div style="font-size:9px; font-weight:900; text-align:left; margin-top:4px;">
            <div style="font-weight:900; margin-bottom:2px; text-align:center;">QUY ĐỊNH ĐỔI TRẢ & LƯU Ý:</div>
            <div style="margin-bottom:1px;">- Đổi trả hàng trong vòng 3 ngày với</div>
            <div style="margin-bottom:1px;">  hóa đơn và sản phẩm còn nguyên vẹn</div>
            <div style="margin-bottom:1px;">- Chỉ đổi hàng khi có lỗi và</div>
            <div style="margin-bottom:1px;">  chưa qua sử dụng</div>
            <div style="margin-bottom:1px;">- Vui lòng kiểm tra kỹ sản phẩm</div>
            <div style="margin-bottom:1px;">  trước khi rời khỏi cửa hàng</div>
            <div style="margin-bottom:1px;">- Mọi thắc mắc xin liên hệ hotline</div>
            <div style="margin-bottom:1px;">- Hóa đơn chỉ có giá trị trong</div>
            <div>  ngày mua hàng</div>
        </div>
        
        <div style="border-top:2px dashed #000; margin:4px 0;"></div>
        
        <div style="text-align:center; margin-top:4px; font-size:10px; font-weight:900;">
            <div style="margin-bottom:1px;">Hẹn gặp lại!</div>
        </div>
    </div>

    <!-- BUTTONS -->
    <div class="mt-4 no-print">
        <a href="/user/pos/history" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Quay lại lịch sử
        </a>
        <a href="/user/pos" class="btn btn-primary">
            <i class="fas fa-home"></i> Quay lại POS
        </a>
        <button type="button" class="btn btn-success" onclick="printReceipt()">
            <i class="fas fa-print"></i> In hóa đơn
        </button>
    </div>
</div>

<script>
function printReceipt() {
    const invoiceBox = document.getElementById('invoiceContent').querySelector('.receipt-container').cloneNode(true);

    const printWindow = window.open('', '', 'width=300,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>HÓA ĐƠN ĐỔI/TRẢ HÀNG</title>
            <style>
                body { 
                    font-family: 'Courier New', monospace; 
                    background: #fff; 
                    color: #000; 
                    margin: 0;
                    padding: 10px;
                    font-weight: 900 !important;
                }
                .receipt-container { 
                    width: 280px; 
                    font-size: 12px; 
                    margin: 0 auto; 
                    line-height: 1.4;
                    font-weight: 900 !important;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    font-weight: 900 !important;
                }
                th, td { 
                    padding: 2px 0; 
                    font-size: 11px;
                    font-weight: 900 !important;
                }
                th { 
                    border-bottom: 2px solid #000; 
                    font-weight: 900 !important; 
                }
                div, span, th, td { 
                    font-weight: 900 !important; 
                    color: #000 !important;
                }
                .total-row {
                    border-top: 2px solid #000;
                    font-weight: 900 !important;
                }
                @media print {
                    @page {
                        size: 58mm 210mm;
                        margin: 2mm !important;
                    }
                    body { 
                        margin: 0 !important; 
                        padding: 2px !important; 
                        font-size: 11px !important;
                        font-weight: 900 !important;
                    }
                    .receipt-container { 
                        width: 100% !important; 
                        max-width: 56mm !important;
                        font-size: 11px !important;
                        line-height: 1.2 !important;
                        font-weight: 900 !important;
                    }
                    div, span, th, td { 
                        font-weight: 900 !important; 
                        color: #000 !important;
                    }
                    th, td {
                        font-size: 11px !important;
                        line-height: 1.2 !important;
                        font-weight: 900 !important;
                    }
                }
            </style>
        </head>
        <body>
            <div class="receipt-container">
                ${invoiceBox.innerHTML}
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 250);
}
</script>
</body>
</html>