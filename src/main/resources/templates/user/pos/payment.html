<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán - POS Bán Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .payment-container { max-width: 800px; margin: 50px auto; }
        .order-summary { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .payment-methods { background: white; border-radius: 10px; padding: 20px; margin-top: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .total-section { background: linear-gradient(45deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .receipt-modal .modal-dialog { max-width: 600px; }
        @media print { .no-print { display: none; } body * { visibility: hidden; } .receipt-modal .modal-content { visibility: visible; position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body>
    <div class="container payment-container">
        <h2 class="text-center mb-4"><i class="fas fa-credit-card"></i> Thanh Toán Đơn Hàng</h2>
        
        <!-- Tóm tắt đơn hàng -->
        <div class="order-summary">
            <h5><i class="fas fa-shopping-cart"></i> Tóm Tắt Đơn Hàng</h5>
            <div id="orderSummary">
                <div class="mb-3">
                    <strong>Khách hàng:</strong> 
                    <span th:if="${selectedCustomer != null}" th:text="${selectedCustomer.name}"></span>
                    <span th:if="${selectedCustomer == null}">Khách lẻ</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>SL</th>
                                <th>Giá</th>
                                <th>Tổng</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${cartItems}">
                                <td th:text="${item.productName}"></td>
                                <td th:text="${item.quantity}"></td>
                                <td th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></td>
                                <td th:text="${#numbers.formatDecimal(item.quantity * item.price, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Phương thức thanh toán -->
        <div class="payment-methods">
            <h5><i class="fas fa-money-bill-wave"></i> Chọn Phương Thức Thanh Toán</h5>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="cash" checked>
                <label class="form-check-label" for="cash">
                    <i class="fas fa-money-bill-wave"></i> Tiền Mặt
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card">
                <label class="form-check-label" for="card">
                    <i class="fas fa-credit-card"></i> Thẻ Tín Dụng/Ghi Nợ
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="transfer" value="transfer">
                <label class="form-check-label" for="transfer">
                    <i class="fas fa-university"></i> Chuyển Khoản Ngân Hàng
                </label>
            </div>
        </div>
        
        <!-- Tổng tiền và nút thanh toán -->
        <div class="total-section">
            <div class="d-flex justify-content-between mb-2">
                <span>Tổng sản phẩm:</span>
                <strong id="totalItems" th:text="${#aggregates.sum(cartItems.![quantity])}"></strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Tạm tính:</span>
                <strong id="subtotal" th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Giảm giá VIP:</span>
                <strong id="vipDiscount" th:text="${vipDiscountAmount > 0 ? '-' + #numbers.formatDecimal(vipDiscountAmount, 0, 'COMMA', 0, 'POINT') + ' VNĐ' : '0 VNĐ'}"></strong>
            </div>
            <div class="d-flex justify-content-between mb-3 fs-4">
                <span><strong>THÀNH TIỀN:</strong></span>
                <strong id="grandTotal" th:text="${#numbers.formatDecimal(finalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></strong>
            </div>
            <form id="paymentForm" th:action="@{/user/pos/process-payment}" method="post">
                <input type="hidden" name="paymentMethod" id="paymentMethodInput" value="cash">
                <input type="hidden" name="notes" value="">
                <input type="hidden" name="createVipRequest" th:value="${selectedCustomer != null and selectedCustomer.id != null and subtotal >= 2000000 and !selectedCustomer.vip and !selectedCustomer.pendingVip ? 'true' : 'false'}">
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-check"></i> Xác Nhận Thanh Toán
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Quay Lại
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body text-center py-4 bg-light">
                    <div class="spinner-grow text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h6 class="text-muted mb-0">Đang xử lý thanh toán...</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" th:if="${success != null}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check-circle"></i> Thanh Toán Thành Công</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h4 th:text="${success}"></h4>
                    <p th:if="${vipMessage != null}" th:text="${vipMessage}"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="showReceiptModal()">
                        <i class="fas fa-print"></i> In Hóa Đơn
                    </button>
                    <button class="btn btn-secondary" onclick="newTransaction()">
                        <i class="fas fa-plus"></i> Giao Dịch Mới
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal fade receipt-modal" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-invoice"></i> Hóa Đơn Cửa Hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receiptContent">
                    <!-- Nội dung sẽ được load qua AJAX -->
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">
                        <i class="fas fa-print"></i> In Hóa Đơn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cập nhật paymentMethod khi chọn radio
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('paymentMethodInput').value = this.value;
                });
            });

            // Hiển thị modal success nếu có
            if (document.getElementById('successModal')) {
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            }
        });

        function goBack() {
            window.location.href = '/user/pos';
        }

        function newTransaction() {
            fetch('/user/pos/clear-session', { method: 'POST' })
                .then(() => {
                    window.location.href = '/user/pos';
                })
                .catch(() => {
                    window.location.href = '/user/pos';
                });
        }

        function showReceiptModal() {
            const orderId = /* Lấy orderId từ session, giả sử truyền qua Thymeleaf hoặc fetch */
            // Giả sử bạn có cách lấy orderId, ví dụ từ hidden input hoặc fetch từ server
            // Để đơn giản, giả sử có một endpoint để lấy orderId từ session
            fetch('/user/pos/get-current-order-id')
                .then(response => response.json())
                .then(data => {
                    if (data.orderId) {
                        fetch(`/user/pos/receipt-data/${data.orderId}`)
                            .then(response => response.json())
                            .then(orderData => {
                                if (orderData.success) {
                                    populateReceiptModal(orderData.data);
                                    const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
                                    receiptModal.show();
                                } else {
                                    alert('Lỗi: ' + orderData.message);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Không thể tải dữ liệu hóa đơn');
                            });
                    } else {
                        alert('Không tìm thấy orderId');
                    }
                })
                .catch(() => {
                    alert('Không thể lấy orderId');
                });
        }

        // ...existing code...

function populateReceiptModal(orderData) {
    const content = `
        <div class="receipt-container">
            <div class="text-center mb-3">
                <h3>HÓA ĐƠN BÁN HÀNG</h3>
                <p>Mã đơn: <strong>${orderData.orderNumber}</strong></p>
                <p>Ngày: <strong>${new Date(orderData.createdAt).toLocaleString()}</strong></p>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <h5>Thông Tin Khách Hàng</h5>
                    ${orderData.customer ? `
                        <p>Tên: ${orderData.customer.name}</p>
                        <p>SĐT: ${orderData.customer.phone}</p>
                        <p>Địa chỉ: ${orderData.customer.address || 'N/A'}</p>
                        <p>VIP: ${orderData.customer.vip ? 'Có' : 'Không'}</p>
                    ` : `
                        <p>Khách lẻ</p>
                    `}
                </div>
                <div class="col-md-6">
                    <h5>Thông Tin Cửa Hàng</h5>
                    <p>Địa chỉ: 123 Đường ABC, Quận XYZ, TP.HCM</p>
                    <p>SĐT: 0123-456-789</p>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Sản Phẩm</th>
                        <th>SL</th>
                        <th>Đơn Giá</th>
                        <th>Thành Tiền</th>
                    </tr>
                </thead>
                <tbody>
                    ${orderData.items.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unitPrice.toLocaleString()} VNĐ</td>
                            <td>${item.totalPrice.toLocaleString()} VNĐ</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="text-end">
                <p>Tổng: ${orderData.totalAmount.toLocaleString()} VNĐ</p>
                ${orderData.vipDiscountAmount > 0 ? `<p>Giảm VIP: -${orderData.vipDiscountAmount.toLocaleString()} VNĐ</p>` : ''}
                <h5>Tổng Thanh Toán: ${orderData.finalAmount.toLocaleString()} VNĐ</h5>
            </div>
            <div class="text-center mt-3">
                <p>Cảm ơn quý khách đã mua hàng!</p>
            </div>
        </div>
    `;
    document.getElementById('receiptContent').innerHTML = content;
}

// ...existing code...
        function printReceipt() {
    const receipt = document.getElementById('receiptContent');
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>HÓA ĐƠN BÁN HÀNG</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: Arial, sans-serif; background: #fff; }
                .receipt-container { margin: 30px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ccc; padding: 8px; }
                th { background: #f8f9fa; }
                h3, h5 { margin-bottom: 10px; }
                .text-end { text-align: right; }
                .text-center { text-align: center; }
            </style>
        </head>
        <body>
            ${receipt.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}
    </script>
</body>
</html>